
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Descriptions</title>
<link rel="shortcut icon" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/prooph-logo@0.5x.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-57-precomposed.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@prooph_software">
<meta name="twitter:title" content="Event Engine">
<meta name="twitter:description" content="Rapid CQRS / ES framework for PHP with a path to refactor towards a richer domain model as needed.">
<meta name="twitter:image" content="https://event-engine.io/img/Event_Engine_intro.png">
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/flatly/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }
    code span.comment {
        white-space: pre;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc {
        padding: 0;
    }

    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
        margin: 0;
    }

    .list-toc li .text-number {
        padding-left: 20px;
    }
    .list-toc li li .text-number {
        padding-left: 40px;
    }
    .list-toc li li li .text-number {
        padding-left: 60px;
    }
    .list-toc li li li li .text-number {
        padding-left: 80px;
    }
    .list-toc li li li li li .text-number {
        padding-left: 100px;
    }
    .list-toc .text-number {
        padding-left: 100px;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0 7px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
    <style>
    body {
        font-size: 16px;
    }
    /* Header Section */
    header {
        font-size: 17px;
        font-weight: 400;
    }

    a {
        color: #04A1B0;
    }

    a:hover, a:active {
        color: #07BDF1;
        text-decoration: none;
    }

    .dropdown-menu {
        font-size: 17px;
    }

    .prooph-logo {
        float: left;
        margin-left: 8px;
        margin-right: 8px;
        transition-timing-function: ease-in-out;
        transition: all 5s;
        height: 50px;
        padding: 5px;
    }

    .jumbotron {
       background-color: #04A1B0;
       margin-top: 60px;
    }

    .jumbotron .display-1 {
        color: white;
    }

    .jumbotron .display-2 {
        color: white;
    }

    .jumbotron pre {
        display: block;
        color: #f8f8f2;
        font-size: 13px;
        margin-top: 60px;
        border-radius: 0;
        border: none;
        background: #272822;
        padding: 1em;
        padding-bottom: 0px;
        overflow: auto;
        text-shadow: 0 1px rgba(0,0,0,0.3);
        font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.5;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }

    .jumbotron pre.line-numbers {
        position: relative;
        padding-left: 3.8em;
        counter-reset: linenumber;
    }

    .jumbotron pre code {
        color: white;
        margin-left: -80px;
    }


    h2.front {
        text-align: center;
        font-size: 56px;
        margin-top: 100px;
        padding: 20px;
    }

    .intro {
        margin-top: 30px;
        font-size: 24px;
        font-weight: 200;
    }

    .intro.sub-intro {
        margin-top: 15px;
        margin-bottom: 15px;
    }

    .flavour {
        height: 200px;
    }

    .flavour h3 {
        color: white;
        font-size: 30px;
    }

    .flavour h3 small {
        color: #f2f2f2;
        font-size: 20px;
    }

    .flavour.prototyping {
        background-color: #CC3340;
    }

    .flavour.functional {
        background-color: #EB6842;
    }

    .flavour.oop {
        background-color: #715671;
    }

    .flavour.mixed {
        background-color: #26896C;
    }

    .btn-get-started {
        background-color: #04A1B0;
        color: white;
        padding: 20px 26px;
        font-size: 35px;
        border-radius: 8px;
        width: 100%;
        -webkit-transition-duration: 0.4s; /* Safari */
        transition-duration: 0.4s;
    }

    .btn-get-started:hover {
        background-color: #04c8d7;
        color: white;
        margin-top: 0px;
    }

    .img-center {
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: 50%;
    }


    #forkongithub a {
        background: #000;
        color: #fff;
        text-decoration: none;
        font-family: arial, sans-serif;
        text-align: center;
        font-weight: bold;
        padding: 5px 40px;
        font-size: 1rem;
        line-height: 2rem;
        position: relative;
        transition: 0.5s;
    }

    #forkongithub a:hover {
        background: #04c8d7;
        color: #fff;
    }

    #forkongithub a::before, #forkongithub a::after {
        content: "";
        width: 100%;
        display: block;
        position: absolute;
        top: 1px;
        left: 0;
        height: 1px;
        background: #fff;
    }

    #forkongithub a::after {
        bottom: 1px;
        top: auto;
    }

    .first-row {
        margin-top: 30px;
    }

    @media screen and (min-width: 800px) {
        #forkongithub {
            position: fixed;
            display: block;
            top: 0;
            right: 0;
            width: 200px;
            overflow: hidden;
            height: 200px;
            z-index: 1000;
        }

        #forkongithub a {
            width: 200px;
            position: absolute;
            top: 85px;
            right: -60px;
            transform: rotate(45deg);
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            -moz-transform: rotate(45deg);
            -o-transform: rotate(45deg);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
        }
    }

    @media screen and (max-width: 799px) {
        .first-row {
            margin-top: 80px;
        }
    }

    @media screen and (max-width: 991px) {
        .jumbotron pre {
            display: none;
        }

        .flavour {
            margin-top: 60px;
        }
    }

    .navbar-default {
        background-color: rgb(0,63,105);
    }

    .navbar-front {
        background-color: rgb(243, 243, 243);
    }

    .navbar-default .navbar-nav>li>a:hover {
        color: #04A1B0;
        text-decoration: none;
    }



    .alert {
        border-width: 0 0 0 4px;
        background-color: transparent;
        color: inherit;
    }

    .alert-light {
        border-color: #715671;
        color: #818182;
        background-color: #fefefe;
    }

    .alert-dark {
        color: #1b1e21;
        background-color: #d6d8d9;
        border-color: #c6c8ca;
    }

    .alert-info {
        border-color: #04A1B0;
    }

    .alert-warning {
        border-color: #EB6842;
    }

    .alert-danger {
        border-color: #CC3340;
    }

    .alert-success {
        border-color: #26896C;
    }

    .alert .alert-link {
        color: #04A1B0;
        text-decoration: none;
    }

    .alert .alert-link:hover, .alert .alert-link:active {
        color: #07BDF1;
        text-decoration: none;
    }

    .alert.alert-important {
        border-width: 0 1px 4px 1px;
        background-color: #CC3340;
        color: #fff;
    }

    .alert.alert-important .alert-link {
        color: #ffffff;
        text-decoration: underline;
    }

    .alert.alert-important .alert-link:hover, .alert .alert-link:active {
        color: #ee374b;
        text-decoration: underline;
    }

    .list-toc > li:nth-child(2n+1) {
        background: none;
    }

    .list-toc .list-group-item:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }

</style>
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-flatly">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="https://event-engine.io/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://event-engine.io/">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                    <defs>
                        <style>
                            .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                        </style>
                    </defs>
                    <title>prooph-logo</title>
                    <g id="artwork">
                        <g id="Layer_5" data-name="Layer 5">
                            <path class="cls-1"
                                  d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                            <path class="cls-2"
                                  d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                            <path class="cls-3"
                                  d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                            <path class="cls-4"
                                  d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                            <path class="cls-5"
                                  d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                            <path class="cls-6"
                                  d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                        </g>
                    </g>
                </svg>
            </a>

        </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="https://event-engine.io/intro.html">About Event Engine</a>

    </li>
                        <li>
    <a href="https://event-engine.io/tutorial/">Tutorial</a>

    </li>
                        <li>
    <a href="https://event-engine.io/api/">Docs</a>

    </li>
                        <li>
    <a href="https://event-engine.io/news/">News</a>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <div class="row first-row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#3-2" title="Descriptions">
                    Descriptions                </a>
            </li>
                                <li>
                <a href="#3-2-1" title="Registration&#x20;API">
                    Registration API                </a>
            </li>
                                <li>
                <a href="#3-2-2" title="Message&#x20;Payload&#x20;Schema">
                    Message Payload Schema                </a>
            </li>
                                <li>
                <a href="#3-2-3" title="Command&#x20;Registration">
                    Command Registration                </a>
            </li>
                                <li>
                <a href="#3-2-4" title="Command&#x20;Processing">
                    Command Processing                </a>
            </li>
                                <li>
                <a href="#3-2-4-1" title="process&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;process()                </a>
            </li>
                                <li>
                <a href="#3-2-4-2" title="withNew&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;withNew()                </a>
            </li>
                                <li>
                <a href="#3-2-4-3" title="identifiedBy&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;identifiedBy()                </a>
            </li>
                                <li>
                <a href="#3-2-4-4" title="withExisting&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;withExisting()                </a>
            </li>
                                <li>
                <a href="#3-2-4-5" title="provideContext&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;provideContext()                </a>
            </li>
                                <li>
                <a href="#3-2-4-6" title="handle&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;handle()                </a>
            </li>
                                <li>
                <a href="#3-2-4-7" title="recordThat&#x28;&#x29;&#x20;&amp;amp&#x3B;&#x20;apply&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;recordThat() &amp; apply...                </a>
            </li>
                                <li>
                <a href="#3-2-4-8" title="storeStateIn&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;storeStateIn()                </a>
            </li>
                                <li>
                <a href="#3-2-4-9" title="storeEventsIn&#x28;&#x29;">
                    &nbsp;&nbsp;&nbsp;&nbsp;storeEventsIn()                </a>
            </li>
                                <li>
                <a href="#3-2-5" title="passToController&#x28;&#x29;">
                    passToController()                </a>
            </li>
                                <li>
                <a href="#3-2-6" title="Event&#x20;Registration">
                    Event Registration                </a>
            </li>
                                <li>
                <a href="#3-2-7" title="Attach&#x20;Process&#x20;Manager">
                    Attach Process Manager                </a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="3-2">Descriptions</h1>
<p>In the previous chapter "Set Up" we already learned that Event Engine loads <code>EventEngineDescription</code>s and passes itself as the only argument
to a static <code>describe</code> method.</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace Prooph\EventEngine;

interface EventEngineDescription
{
    public static function describe(EventEngine $eventEngine): void;
}

</code></pre>
<p class="alert alert-warning">Descriptions need to be loaded <strong>before</strong> <code>EventEngine::initialize()</code> is called.</p>
<p class="alert alert-light">In the skeleton descriptions are listed in <a class="alert-link" href="https://github.com/event-engine/php-engine-skeleton/blob/master/src/Domain/DomainServices.php#L16">src/Domain/DomainServices.php</a>
and this list is read by the event engine factory method in <code>src/ServiceFactory</code>:</p>
<pre><code class="language-php">public function eventEngine($notInitialized = false): EventEngine
{
    if($notInitialized) {
        $eventEngine = new EventEngine(new OpisJsonSchema());
        foreach ($this-&gt;eventEngineDescriptions() as $description) {
            $eventEngine-&gt;load($description);
        }
        return $eventEngine;
    }
    
    $this-&gt;assertContainerIsset();
    
    return $this-&gt;makeSingleton(EventEngine::class, function () {
        $eventEngine = new EventEngine(new OpisJsonSchema());
        foreach ($this-&gt;eventEngineDescriptions() as $description) {
            $eventEngine-&gt;load($description);
        }
        $eventEngine-&gt;initialize(
            $this-&gt;flavour(),
            $this-&gt;multiModelStore(),
            $this-&gt;logEngine(),
            $this-&gt;container
        );
        return $eventEngine;
    });
}
</code></pre>
<p class="alert alert-info"><strong>Organising Descriptions:</strong>
If you followed the tutorial, you already know that you can avoid code duplication and typing errors with a few simple tricks.
Clever combinations of class and constant names can provide readable code without much effort. The skeleton ships with default Event Engine Descriptions
to support you with that idea. You can find them in <a class="alert-link" href="https://github.com/event-engine/php-engine-skeleton/tree/master/src/Domain/Api">src/Domain/Api</a></p>
<h2 id="3-2-1">Registration API</h2>
<p>Event Engine provides various <code>registration</code> methods. Those methods can only be called during <strong>description phase</strong>.</p>
<p class="alert alert-light">See <a href="/api/set-up/installation.html#3-1-1-3">Set Up chapter</a> for details about bootstrap phases.</p>
<p>Here is an overview of available methods:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace Prooph\EventEngine;

//...

final class EventEngine implements MessageDispatcher, AggregateStateStore
{
    //...

    /**
     * Add a command message to the system along with its payload schema
     */
    public function registerCommand(string $commandName, PayloadSchema $schema): self
    {
        //...
    }

    /**
     * Add an event message to the system along with its payload schema
     */
    public function registerEvent(string $eventName, PayloadSchema $schema): self
    {
        //...
    }

    /**
     * Add a query message to the system along with its payload schema (optional for queries)
     */
    public function registerQuery(string $queryName, PayloadSchema $payloadSchema = null): QueryDescription
    {
        //...
    }
    
    /**
     * Add a data type to the system along with its schema
     */
    public function registerResponseType(string $nameOrImmutableRecordClass, ResponseTypeSchema $schema = null): void
    {
        //...
    }

    /**
     * Alias for registerResponseType()
     */
    public function registerType(string $nameOrImmutableRecordClass, ResponseTypeSchema $schema = null): void
    {
        //...
    }
    
    /**
     * Add an input data type to the system along with its schema
     * 
     * If the schema implemenation distinguishes between input and data types (f.e. a GraphQL implementation)
     * you can use registerReponseType() and registerInputType() explicitly 
     */
    public function registerInputType(string $nameOrImmutableRecordClass, InputTypeSchema $schema = null): void
    {
        //...
    }

    /**
     * Service id or instance of a CommandPreProcessor invoked before command is dispatched
     * 
     * You can register many preprocessors per command. Think of it like a middleware pipeline.
     *
     * @param string $commandName
     * @param string | CommandPreProcessor $preProcessor
     */
    public function preProcess(string $commandName, $preProcessor): self
    {
        //...
    }
    
    /**
     * Service id or callable command controller invoked for command instead of an aggregate
     *
     * You can use controllers for non-aggregate business logic, migrations and more
     * A command can either be handled by an aggregate or a controller. 
     * Event Engine takes care of this. 
     * 
     * @param string $commandName
     * @param string|callable $controller
     * @return EventEngine
     */
    public function passToController(string $commandName, $controller): self
    {
        //...
    }

    /**
     * Describe handling of a command using returned CommandProcessorDescription
     */
    public function process(string $commandName): CommandProcessorDescription
    {
        //...
    }

    /**
     * Service id or callable event listener invoked after event is written to event stream
     *
     * @param string $eventName
     * @param string | callable $listener
     */
    public function on(string $eventName, $listener): self
    {
        //...
    }

    /**
     * Describe a projection by using returned ProjectionDescription
     */
    public function watch(Stream $stream): ProjectionDescription
    {
        //...
    }

    //...
}

</code></pre>
<h2 id="3-2-2">Message Payload Schema</h2>
<p>Messages are like HTTP requests, but they are protocol agnostic. For HTTP requests/responses PHP-FIG has defined a standard known as PSR-7. Event Engine messages on the other hand are similar to <a href="https://github.com/prooph/common/blob/master/docs/messaging.md">prooph/common messages</a>.</p>
<p>Like HTTP requests <strong>messages should be validated before doing anything with them</strong>. It can become a time consuming task to write validation logic for each message
by hand. Hence, Event Engine has a built-in way to validate messages using a <a href="#">Schema</a> (@TODO add link).</p>
<p>The package <a href="https://github.com/event-engine/php-json-schema">event-engine/php-json-schema</a> provides a <a href="http://json-schema.org/specification-links.html#draft-6">Json Schema Draft 6</a> compatible implementation.</p>
<p>You can use <code>JsonSchema</code> wrapper objects. Those objects are easy to use and drastically improve
readability of the code.</p>
<p>Here is a command registration example:</p>
<pre><code class="language-php">$eventEngine-&gt;registerCommand(
    self::REGISTER_USER,
    JsonSchema::object([
        Payload::USER_ID =&gt; Schema::userId(),
        Payload::USERNAME =&gt; Schema::username(),
        Payload::EMAIL =&gt; Schema::email(),
    ])
);
</code></pre>
<p class="alert alert-success">This code speaks for itself, doesn't it? Once you're used to it you can add new messages to the system in less than 30 seconds.
The chapter about <a href="#">Json Schema</a> (@TODO add link) covers all the details. Make sure to check it out.</p>
<p class="alert alert-light">A nice side effect of this approach is out-of-the-box <a class="alert-link" href="https://swagger.io/tools/swagger-ui/">Swagger UI</a> support.
Learn more about it in the <a href="#">Swagger UI</a> (@TODO add link) chapter.</p>
<h2 id="3-2-3">Command Registration</h2>
<p>Event Engine needs to know which commands can be processed by the system. Therefor, you have to register them before defining processing logic.</p>
<p class="alert alert-light">Software developed with Event Engine follows a Command-Query-Responsibility-Segregation (short CQRS) approach.
Commands are used to trigger state changes without returning modified state and queries are used to request current state without modifying it.</p>
<p>You're ask to tell Event Engine a few details about available commands. Each command should have a <strong>unique name</strong> and a <strong>payload schema</strong>.
It is recommended to add a context as prefix in front of each command name. Let's take an example from the tutorial but add a context to the command name:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Api;

use Prooph\EventEngine\EventEngine;
use Prooph\EventEngine\EventEngineDescription;
use Prooph\EventEngine\JsonSchema\JsonSchema;

class Command implements EventEngineDescription
{
    const CMD_CXT = 'BuildingMgmt.';
    const ADD_BUILDING = self::CMD_CXT.'AddBuilding';

    /**
     * @param EventEngine $eventEngine
     */
    public static function describe(EventEngine $eventEngine): void
    {
        $eventEngine-&gt;registerCommand(
            Command::ADD_BUILDING,
            JsonSchema::object(
                [
                    'buildingId' =&gt; JsonSchema::uuid(),
                    'name' =&gt; JsonSchema::string()-&gt;withMinLength(2)
                ]
            )
        );
    }
}

</code></pre>
<p>Event Engine makes no assumptions about the format of the name. A common approach is to use a <em>dot notation</em> to separate context from message name
e.g. <code>BuildingMgmt.AddBuilding</code>. Using <em>dot notation</em> has the advantage that message broker like RabbitMQ can use it for routing.</p>
<h2 id="3-2-4">Command Processing</h2>
<p>Once Event Engine knows about a command you can register processing logic for it. Commands are processed by <strong>aggregate functions</strong>. Think of an aggregate as a process with
multiple steps. Each step is triggered by a command and there is only one active step for a specific process aka. aggregate at the same time.</p>
<p><img src="https://event-engine.io/api/img/order_stream.png" alt="Order Stream"></p>
<p>In Event Engine aggregate functions are <strong>stateless</strong>. You can use plain PHP functions or classes with static public methods.</p>
<p>Before we dive deeper into aggregate functions, let's have a look at how commands are processed.
The following gif shows a <code>CommandProcessingDescription</code>.</p>
<p class="alert alert-success">A fluent interface mixed with clever class and constant naming + modern IDE support (PHPStorm in this case)
can assist you while putting together the pieces. You need to remember less which frees your mind to reason more about
the logic you're developing. This results in a <strong>higher quality business logic, written in a shorter time.</strong>
Try it yourself. It's actually a lot of fun to work with Event Engine.</p>
<p class="alert alert-info">Keep an eye on the array callable syntax: <code>[ShoppingCart::class, 'addItem']</code>. PHPStorm provides code completion for it and respects it while renaming methods and classes.
That's an awesome feature and makes the syntax save to use.</p>
<p><img src="https://event-engine.io/api/img/desc.gif" alt="Command Processing Description"></p>
<p class="alert alert-success">Event Engine Descriptions keep glue code outside of the core business logic. This reduces "noise" in the core and creates
a central overview for navigation through the code.</p>
<p>Let's go through the CommandProcessingDescription step by step.</p>
<h3 id="3-2-4-1">process()</h3>
<p>The <code>process(string $commandName)</code> method takes a command name as input and starts a <strong>CommandProcessingDescription</strong> for that command.</p>
<p class="alert alert-warning">If the command is not registered or a second processing description exists for it, Event Engine raises an exception.
There can always only be one handler for a command be it an aggregate or a controller. You can only attach multiple
command preprocessors to the same command.</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::START_SHOPPING_SESSION)
</code></pre>
<h3 id="3-2-4-2">withNew()</h3>
<p class="alert alert-info">Event Engine Descriptions are really meant to be descriptive. This way you can internalize the required steps
to build a CQRS / ES system. The descriptions also serve as documentation. A developer new to the system just needs
to read them to get an idea of the structure and business logic.</p>
<p>That said, description methods are named to form a sentence. If a command should create a new aggregate use <code>withNew(string $aggregateType)</code> after <code>process()</code>
and pass the aggregate type as an argument:</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::START_SHOPPING_SESSION)
    -&gt;withNew(Aggregate::SHOPPING_CART)
</code></pre>
<h3 id="3-2-4-3">identifiedBy()</h3>
<p>If a new aggregate should be created, you have to tell Event Engine which command property contains the aggregate identifier. This is done
with <code>identifiedBy(string $identifierPropName)</code>:</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::START_SHOPPING_SESSION)
    -&gt;withNew(Aggregate::SHOPPING_CART)
    -&gt;identifiedBy(Payload::SHOPPING_CART_ID)
</code></pre>
<p>You can omit <code>identifiedBy()</code> in further CommandProcessingDescriptions addressing the same aggregate type as long as all commands and events always contain the same
aggregate identifier property. If this is not the case, you can also add <code>identifiedBy()</code> after <code>withExisting()</code> to define an alternative property name for the specific command
and related events.</p>
<p class="alert alert-warning">If you omit <code>identifiedBy()</code> at all, Event Engine uses the default property name <code>id</code> and throws an exception if the command does not contain it.</p>
<h3 id="3-2-4-4">withExisting()</h3>
<p>Like the name suggests, <code>withExisting(string $aggregateType)</code> should be used if a command addresses an existing aggregate. Event Engine will use the aggregate type and the identifier property from the
command to look up the aggregate and bring it into current state ready to handle the command.</p>
<p class="alert alert-success">Loading aggregates is managed by Event Engine internally. No command handlers or repositories required.</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::ADD_ITEM)
    -&gt;withExisting(Aggregate::SHOPPING_CART)
</code></pre>
<h3 id="3-2-4-5">provideContext()</h3>
<p><code>provideContext(string $providerServiceId)</code> allows you to attach a context provider
to the command. It should be a <strong>service id</strong>. Event Engine pulls the context provider from the <a href="/api/set_up/di.html#3-1-2-5">PSR-11 container</a>.</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::ADD_ITEM)
    -&gt;withExisting(Aggregate::SHOPPING_CART)
    -&gt;provideContext(AddItemContextProvider::class)
</code></pre>
<p class="alert alert-light">Aggregate functions should not have any side effects. This is explained in the <a href="/api/aggregates/functional_core.html">Functional Core</a> chapter.
But to make decisions like: "Should a command be handled or not and in what way?" - an aggregate sometimes requires information not included in its own state.
This information needs to be loaded either from an external system or a database. To keep aggregates focused on the business logic, external
information should be loaded beforehand. A context provider takes care of loading information. It can manage communication, deal with errors and caching.
Once loaded, the information is handed over as context to the aggregate function.</p>
<p class="alert alert-danger">While Event Engine makes no assumptions about the context format, it is highly recommended to only use <a href="/api/state/immutable_state.html">immutable objects</a> as contexts.
In rare cases it might be required to pass a data resolver down to the aggregate, f.e. if the aggregate needs to decide if external data is really needed and fetching it beforehand is too costly.
You can use a context object to pass dependencies into aggregate functions. But use it with care!</p>
<h3 id="3-2-4-6">handle()</h3>
<p><code>handle(callable $aggregateFunc)</code> takes a <code>callable</code> as input. This is usually the aggregate function responsible for handling the command.</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::ADD_ITEM)
    -&gt;withExisting(Aggregate::SHOPPING_CART)
    -&gt;provideContext(AddItemContextProvider::class)
    -&gt;handle([ShoppingCart::class, 'addItem'])
</code></pre>
<p class="alert alert-light">The recommended approach is to group aggregate functions in classes using static class methods. This way, you can use PHP's array callable syntax like shown in the example.
Thanks to the syntax, Event Engine can cache the Description. If you pass a <code>Closure</code> to <code>handle()</code>, caching won't work, because closures can't be exported. Event Engine takes
care of that limitation and throws an exception if needed.</p>
<p class="alert alert-warning">If you use the <code>OopFlavour</code> please refer to the <a class="alert-link" href="/tutorial/bonus_IV.html">OopFlavour tutorial part</a>.
It explains how to describe command processing when aggregate functions are not stateless.</p>
<h3 id="3-2-4-7">recordThat() &amp; apply()</h3>
<p>Tell Event Engine what possible events are yielded for a command using <code>recordThat(string $eventName)</code> or one of the aliases <code>andRecordThat(string $eventName)</code> or <code>orRecordThat(string $eventName)</code>.
Every <code>recordThat()</code> call should be followed by an <code>apply(callable $eventApplyFunc)</code> call, which takes a <code>callable</code> aggregate apply function for the event as argument.</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::ADD_ITEM)
    -&gt;withExisting(Aggregate::SHOPPING_CART)
    -&gt;provideContext(AddItemContextProvider::class)
    -&gt;handle([ShoppingCart::class, 'addItem'])
    -&gt;recordThat(Event::ITEM_ADDED)
    -&gt;apply([ShoppingCart::class, 'whenItemAdded'])
    -&gt;andRecordThat(Event::FREE_SHIPPING_ENABLED)
    -&gt;apply([ShoppingCart::class, 'whenFreeShippingEnabled']);
</code></pre>
<p class="alert alert-info">The aggregate handle function doesn't need to yield all specified events each time and the recordThat aliases are only defined for better readability.
The important thing is, that Event Engine knows all events and their corresponding apply functions.</p>
<h3 id="3-2-4-8">storeStateIn()</h3>
<p><code>storeStateIn(string $collection)</code> tells Event Engine to store the aggregate state in the specified document store collection.
This description only takes effect when using a <a href="#">Multi-Model-Store</a> (@TODO add link). It can only be used when describing
command processing for a <strong>NEW</strong> aggregate:</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::START_SHOPPING_SESSION)
    -&gt;withNew(Aggregate::SHOPPING_CART)
    -&gt;identifiedBy(Payload::SHOPPING_CART_ID)
    -&gt;storeStateIn('shopping_carts')
    // ...
</code></pre>
<p class="alert alert-info">If you don't specify a collection, Event Engine defaults to:</p>
<pre><code class="language-php">$aggregateCollection = AggregateProjector::aggregateCollectionName(
   '0.1.0', // &lt;- Default projection version
   Aggregate::SHOPPING_CART // &lt;- Aggregate type of command processing description
);

echo $aggregateCollection; // em_ds_shopping_cart_0_1_0
</code></pre>
<p class="alert alert-warning">Make sure to create the collection upfront! It is <strong>NOT</strong> created automatically by Event Engine.
The tutorial provides some <a href="/tutorial/partIII.html#2-4-2">guidance</a>.</p>
<h3 id="3-2-4-9">storeEventsIn()</h3>
<p>By default, Event Engine writes all events into its <code>WriteModelStream</code>. If you wish to write events for a certain
aggregate type into a separate stream, you can use <code>storeEventsIn(string $streamName)</code>. Like <code>storeStateIn()</code>, you can
define an alternative stream only when describing command processing for a <strong>new</strong> aggregate.</p>
<pre><code class="language-php">$eventEngine-&gt;process(Command::START_SHOPPING_SESSION)
    -&gt;withNew(Aggregate::SHOPPING_CART)
    -&gt;identifiedBy(Payload::SHOPPING_CART_ID)
    -&gt;storeStateIn('shopping_carts')
    -&gt;storeEventsIn('shopping_cart_history')
    // ...
</code></pre>
<p class="alert alert-warning">You need to take care of creating alternative event streams. The skeleton includes an <a href="https://github.com/event-engine/php-engine-skeleton/blob/master/scripts/create_event_stream.php">example script</a>.
Just change the stream name.</p>
<h2 id="3-2-5">passToController()</h2>
<p>If you don't want to handle a command with an aggregate, you can pass it to a <a href="#">command controller</a> (@TODO add link) instead:</p>
<pre><code class="language-php">$eventEngine-&gt;passToController(MyCommandController::class);
</code></pre>
<p>The controller instance is pulled from the <a href="/api/set_up/di.html#3-1-2-5">PSR-11 container</a> using the <strong>service id</strong> handed over to <code>passToController()</code>.</p>
<p class="alert alert-warning">A command can either be handled by a controller or an aggregate, but not both. A command always has one handler only.</p>
<h2 id="3-2-6">Event Registration</h2>
<p>Event registration works similar to command registration <a href="#3-2-3">described above</a>.
Before you can reference events in <a href="#3-2-4">command processing descriptions</a> they need to be known by Event Engine.
This mechanism protects you from silly mistakes like misspelling an event name or forgetting to define a schema for it.</p>
<pre><code class="language-php">$eventEngine-&gt;registerEvent(
    self::USER_REGISTERED,
    JsonSchema::object([
        Payload::USER_ID =&gt; Schema::userId(),
        Payload::USERNAME =&gt; Schema::username(),
        Payload::EMAIL =&gt; Schema::email(),
    ])
);
</code></pre>
<h2 id="3-2-7">Attach Process Manager</h2>
<p>One of the strengths of Event Sourcing is the ability to automate processes using an Event-Driven approach. This means, that follow up actions can be triggered when certain events
occur. Those automatic triggers are called process managers. Here is an example how you attach a process manager to an event:</p>
<pre><code class="language-php">$eventEngine-&gt;on(Event::USER_REGISTERED, SendWelcomeEmail::class);
</code></pre>
<p>If a process manager has dependencies, pass a <strong>service id</strong> to <code>$eventEngine-&gt;on()</code> so that it is pulled from the <a href="/api/set_up/di.html#3-1-2-5">PSR-11 container</a>.
A stateless process manager that listens on an event to dispatch a new command, can be provided as a <code>callable</code>. It's recommended to use the array callable syntax like
discussed for <a href="#3-2-4-6">aggregate functions</a>.</p>
<p>Let's look at an example:</p>
<p class="alert alert-info">Whenever an order was placed the system should generate an invoice.</p>
<pre><code class="language-php">final class GenerateInvoiceTrigger
{
    public static function onOrderPlaced(Message $orderPlaced): array 
    {
        return [
            Command::GENERATE_INVOICE,
            [
                Payload::ORDER_ID =&gt; $orderPlaced-&gt;get(Payload::ORDER_ID)    
            ]    
        ];
    }
}
</code></pre>
<p>A process manager can return a command using the "short message syntax" of Event Engine.
The command is automatically dispatched by Event Engine. The only thing we need to do is
to attach the process manager function to the correct event:</p>
<pre><code class="language-php">$eventEngine-&gt;on(Event::ORDER_PLACED, [GenerateInvoiceTrigger::class, 'onOrderPlaced']);
</code></pre>
<p>@TODO Describe query, type and projection registration</p>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="https://event-engine.io/api/set_up/production_optimization.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="https://event-engine.io/api/functional_core.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p><a href="http://prooph-software.de/about.html">Imprint</a> | Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<span id="forkongithub"><a href="https://github.com/event-engine/docs">Fork me on GitHub</a></span><script src="//code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="//bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="//tobiju.github.io/share/prismjs/main.js"></script>
<script src="//tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
<script src="https://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
</body></html>

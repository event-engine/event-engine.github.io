
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Discolight</title>
<link rel="shortcut icon" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/prooph-logo@0.5x.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="https://raw.githubusercontent.com/prooph/proophessor/gh-pages/images/ico/apple-touch-icon-57-precomposed.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@prooph_software">
<meta name="twitter:title" content="Event Engine">
<meta name="twitter:description" content="Rapid CQRS / ES framework for PHP with a path to refactor towards a richer domain model as needed.">
<meta name="twitter:image" content="https://event-engine.io/img/Event_Engine_intro.png">
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/flatly/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }
    code span.comment {
        white-space: pre;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc {
        padding: 0;
    }

    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
        margin: 0;
    }

    .list-toc li .text-number {
        padding-left: 20px;
    }
    .list-toc li li .text-number {
        padding-left: 40px;
    }
    .list-toc li li li .text-number {
        padding-left: 60px;
    }
    .list-toc li li li li .text-number {
        padding-left: 80px;
    }
    .list-toc li li li li li .text-number {
        padding-left: 100px;
    }
    .list-toc .text-number {
        padding-left: 100px;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0 7px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
    <style>
    body {
        font-size: 16px;
    }
    /* Header Section */
    header {
        font-size: 17px;
        font-weight: 400;
    }

    a {
        color: #04A1B0;
    }

    a:hover, a:active {
        color: #07BDF1;
        text-decoration: none;
    }

    .dropdown-menu {
        font-size: 17px;
    }

    .prooph-logo {
        float: left;
        margin-left: 8px;
        margin-right: 8px;
        transition-timing-function: ease-in-out;
        transition: all 5s;
        height: 50px;
        padding: 5px;
    }

    .jumbotron {
       background-color: #04A1B0;
       margin-top: 60px;
    }

    .jumbotron .display-1 {
        color: white;
    }

    .jumbotron .display-2 {
        color: white;
    }

    .jumbotron pre {
        display: block;
        color: #f8f8f2;
        font-size: 13px;
        margin-top: 60px;
        border-radius: 0;
        border: none;
        background: #272822;
        padding: 1em;
        padding-bottom: 0px;
        overflow: auto;
        text-shadow: 0 1px rgba(0,0,0,0.3);
        font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.5;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
    }

    .jumbotron pre.line-numbers {
        position: relative;
        padding-left: 3.8em;
        counter-reset: linenumber;
    }

    .jumbotron pre code {
        color: white;
        margin-left: -80px;
    }


    h2.front {
        text-align: center;
        font-size: 56px;
        margin-top: 100px;
        padding: 20px;
    }

    .intro {
        margin-top: 30px;
        font-size: 24px;
        font-weight: 200;
    }

    .intro.sub-intro {
        margin-top: 15px;
        margin-bottom: 15px;
    }

    .flavour {
        height: 200px;
    }

    .flavour h3 {
        color: white;
        font-size: 30px;
    }

    .flavour h3 small {
        color: #f2f2f2;
        font-size: 20px;
    }

    .flavour.prototyping {
        background-color: #CC3340;
    }

    .flavour.functional {
        background-color: #EB6842;
    }

    .flavour.oop {
        background-color: #715671;
    }

    .flavour.mixed {
        background-color: #26896C;
    }

    .btn-get-started {
        background-color: #04A1B0;
        color: white;
        padding: 20px 26px;
        font-size: 35px;
        border-radius: 8px;
        width: 100%;
        -webkit-transition-duration: 0.4s; /* Safari */
        transition-duration: 0.4s;
    }

    .btn-get-started:hover {
        background-color: #04c8d7;
        color: white;
        margin-top: 0px;
    }

    .img-center {
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: 50%;
    }


    #forkongithub a {
        background: #000;
        color: #fff;
        text-decoration: none;
        font-family: arial, sans-serif;
        text-align: center;
        font-weight: bold;
        padding: 5px 40px;
        font-size: 1rem;
        line-height: 2rem;
        position: relative;
        transition: 0.5s;
    }

    #forkongithub a:hover {
        background: #04c8d7;
        color: #fff;
    }

    #forkongithub a::before, #forkongithub a::after {
        content: "";
        width: 100%;
        display: block;
        position: absolute;
        top: 1px;
        left: 0;
        height: 1px;
        background: #fff;
    }

    #forkongithub a::after {
        bottom: 1px;
        top: auto;
    }

    .first-row {
        margin-top: 30px;
    }

    @media screen and (min-width: 800px) {
        #forkongithub {
            position: fixed;
            display: block;
            top: 0;
            right: 0;
            width: 200px;
            overflow: hidden;
            height: 200px;
            z-index: 1000;
        }

        #forkongithub a {
            width: 200px;
            position: absolute;
            top: 85px;
            right: -60px;
            transform: rotate(45deg);
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            -moz-transform: rotate(45deg);
            -o-transform: rotate(45deg);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
        }
    }

    @media screen and (max-width: 799px) {
        .first-row {
            margin-top: 80px;
        }
    }

    @media screen and (max-width: 991px) {
        .jumbotron pre {
            display: none;
        }

        .flavour {
            margin-top: 60px;
        }
    }

    .navbar-default {
        background-color: rgb(0,63,105);
    }

    .navbar-front {
        background-color: rgb(243, 243, 243);
    }

    .navbar-default .navbar-nav>li>a:hover {
        color: #04A1B0;
        text-decoration: none;
    }



    .alert {
        border-width: 0 0 0 4px;
        background-color: transparent;
        color: inherit;
    }

    .alert-light {
        border-color: #715671;
        color: #818182;
        background-color: #fefefe;
    }

    .alert-dark {
        color: #1b1e21;
        background-color: #d6d8d9;
        border-color: #c6c8ca;
    }

    .alert-info {
        border-color: #04A1B0;
    }

    .alert-warning {
        border-color: #EB6842;
    }

    .alert-danger {
        border-color: #CC3340;
    }

    .alert-success {
        border-color: #26896C;
    }

    .alert .alert-link {
        color: #04A1B0;
        text-decoration: none;
    }

    .alert .alert-link:hover, .alert .alert-link:active {
        color: #07BDF1;
        text-decoration: none;
    }

    .alert.alert-important {
        border-width: 0 1px 4px 1px;
        background-color: #CC3340;
        color: #fff;
    }

    .alert.alert-important .alert-link {
        color: #ffffff;
        text-decoration: underline;
    }

    .alert.alert-important .alert-link:hover, .alert .alert-link:active {
        color: #ee374b;
        text-decoration: underline;
    }

    .list-toc > li:nth-child(2n+1) {
        background: none;
    }

    .list-toc .list-group-item:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }

</style>
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-flatly">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="https://event-engine.io/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://event-engine.io/">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                    <defs>
                        <style>
                            .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                        </style>
                    </defs>
                    <title>prooph-logo</title>
                    <g id="artwork">
                        <g id="Layer_5" data-name="Layer 5">
                            <path class="cls-1"
                                  d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                            <path class="cls-2"
                                  d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                            <path class="cls-3"
                                  d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                            <path class="cls-4"
                                  d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                            <path class="cls-5"
                                  d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                            <path class="cls-6"
                                  d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                        </g>
                    </g>
                </svg>
            </a>

        </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="https://event-engine.io/intro.html">About Event Engine</a>

    </li>
                        <li>
    <a href="https://event-engine.io/tutorial/">Tutorial</a>

    </li>
                        <li>
    <a href="https://event-engine.io/api/">Docs</a>

    </li>
                        <li>
    <a href="https://event-engine.io/news/">News</a>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <div class="row first-row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#3-7" title="Discolight">
                    Discolight                </a>
            </li>
                                <li>
                <a href="#3-7-1" title="Installation">
                    Installation                </a>
            </li>
                                <li>
                <a href="#3-7-2" title="Service&#x20;Factory">
                    Service Factory                </a>
            </li>
                                <li>
                <a href="#3-7-3" title="Service&#x20;Ids">
                    Service Ids                </a>
            </li>
                                <li>
                <a href="#3-7-4" title="Singleton&#x20;Service">
                    Singleton Service                </a>
            </li>
                                <li>
                <a href="#3-7-5" title="Injecting&#x20;Dependencies">
                    Injecting Dependencies                </a>
            </li>
                                <li>
                <a href="#3-7-6" title="Configuration">
                    Configuration                </a>
            </li>
                                <li>
                <a href="#3-7-7" title="Service&#x20;Alias">
                    Service Alias                </a>
            </li>
                                <li>
                <a href="#3-7-8" title="Production&#x20;Optimization">
                    Production Optimization                </a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="3-7">Discolight</h1>
<p>Event Engine was initially designed as a workshop framework, which is still noticeable in its design. <em>Discolight</em> is one of the nice concepts carried over from workshops
into production grade code.</p>
<p class="alert alert-light"><em>Credits</em>: Discolight is inspired by <a href="https://github.com/bitExpert/disco">bitExpert/disco</a> but removes the need for annotations.</p>
<p class="alert alert-info">Discolight is a very small package. It emphasis "Hand-written service containers" similar to what Matthias Noback suggests in this <a href="https://matthiasnoback.nl/2019/03/hand-written-service-containers/">blog post</a>.</p>
<h2 id="3-7-1">Installation</h2>
<pre><code class="language-bash">composer require event-engine/discolight
</code></pre>
<h2 id="3-7-2">Service Factory</h2>
<p>If you walked your way through the tutorial, you already know about Discolight. The <a href="https://github.com/event-engine/php-engine-skeleton">skeleton app</a>
comes preconfigured with it.</p>
<p>You're asked to provide a <code>ServiceFactory</code>, that contains a public factory method for each dependency.
Such a <a href="https://github.com/event-engine/php-engine-skeleton/blob/master/src/ServiceFactory.php">class</a> is included in the skeleton.</p>
<p class="alert alert-light"><em>Note:</em> The skeleton organizes factory methods in module specific traits (<code>src/Domain/DomainServices.php</code>, <code>src/Persistence/PersistenceServices.php</code>, ...) to keep dependencies manageable.
But that's only a suggestion. Each service trait becomes part of the main service factory at runtime. You could also put all methods in one class or organize the traits differently.</p>
<h2 id="3-7-3">Service Ids</h2>
<p>The service factory does not need to implement a specific interface. Instead, Discolight scans it and treats <strong>all public methods</strong> of the class as service factory methods.
The return type of a factory method becomes the <strong>service id</strong>.</p>
<p>Let's look at the <a href="https://github.com/event-engine/php-engine-skeleton/blob/master/src/Persistence/PersistenceServices.php#L47">method</a> which provides the service <code>EventEngine\Persistence\MultiModelStore</code>:</p>
<pre><code class="language-php">public function multiModelStore(): MultiModelStore
{
    return $this-&gt;makeSingleton(MultiModelStore::class, function () {
        return new ComposedMultiModelStore(
            $this-&gt;transactionalConnection(),
            $this-&gt;eventEngineEventStore(),
            $this-&gt;documentStore()
        );
    });
}
</code></pre>
<p>A lot of stuff going on here, so we'll look at it step by step.</p>
<pre><code class="language-php">public function multiModelStore(): MultiModelStore
</code></pre>
<p>It's a <code>public</code> method of the <code>ServiceFactory</code>, therefor <code>EventEngine\Persistence\MultiModelStore</code> becomes the <strong>service id</strong>.
This means that you can do the following to get the multi model store from Discolight:</p>
<pre><code class="language-php">$store = $discolight-&gt;get(MultiModelStore::class);
</code></pre>
<h2 id="3-7-4">Singleton Service</h2>
<p>In most cases we want to get the same instance of a service from the container no matter how often we request it. This is called a <code>Singleton</code>.
Discolight is dead simple. It does not know anything about singletons. Instead we use a pattern called <a href="https://en.wikipedia.org/wiki/Memoization">memoization</a>
to cache the instance of a service in memory and return it from cache on subsequent calls.</p>
<p>The <code>ServiceFactory</code> is userland implementation. No interface implementation required. To add memoization to your service factory use the provided
trait <code>EventEngine\Discolight\ServiceRegistry</code> like it is done in the skeleton service factory.</p>
<pre><code class="language-php">final class ServiceFactory
{
    use ServiceRegistry;
    /* use service traits ... */
</code></pre>
<p>Now you can store service instances in memory:</p>
<pre><code class="language-php">public function multiModelStore(): MultiModelStore
{
    return $this-&gt;makeSingleton(MultiModelStore::class, function () {
        //...
    });
}
</code></pre>
<p>You might recognize that we use <code>MultiModelStore::class</code> again as service id for the registry. The second argument of <code>makeSingleton</code> is a closure which acts
as a <strong>factory function</strong> for the service. When <code>MultiModelStore::class</code> is not in the cache, the factory function is called otherwise the service is returned from the registry.</p>
<h2 id="3-7-5">Injecting Dependencies</h2>
<p>Often one service depends on other services. The multi model store requires a <code>TransactionalConnection</code> an <code>EventStore</code> and a <code>DocumentStore</code>
and because all services are provided by the same <code>ServiceFactory</code> we can simply get those services by calling the appropriate methods.</p>
<p class="alert alert-light">By default a closure is bound to its parent scope (the service factory instance in this case). Hence, insight the closure we have
access to all methods of the service factory no matter if they are declared public, protected or private.</p>
<pre><code class="language-php">public function multiModelStore(): MultiModelStore
{
    return $this-&gt;makeSingleton(MultiModelStore::class, function () {
        return new ComposedMultiModelStore(
            $this-&gt;transactionalConnection(),
            $this-&gt;eventEngineEventStore(),
            $this-&gt;documentStore()
        );
    });
}
</code></pre>
<p>The multi model store interface is service id and return type at the same time. Therefor, PHP's type system ensures at runtime that a valid store is returned.
Internally, we built a <code>ComposedMultiModelStore</code>. If we want to switch the store
we can return another implementation.</p>
<h2 id="3-7-6">Configuration</h2>
<p>Another thing that is out of scope for Discolight is application configuration. Remember: <em>providing a working <code>ServiceFactory</code> is your task</em>. When services
need configuration then pass it to the ServiceFactory. The skeleton uses environmental variables mapped to config params in
<a href="https://github.com/event-engine/php-engine-skeleton/blob/master/config/autoload/global.php#L14">config/autoload/global.php</a>.</p>
<p>The configuration array is then passed to the <code>ServiceFactory</code> in the constructor and wrapped with an <code>ArrayReader</code>:</p>
<pre><code class="language-php">final class ServiceFactory
{
    use ServiceRegistry;

    //...

    public function __construct(array $appConfig)
    {
        $this-&gt;config = new ArrayReader($appConfig);
    }
</code></pre>
<p>This way we have access to the configuration when building our services. We can see this in action in the <a href="https://github.com/event-engine/php-engine-skeleton/blob/master/src/Persistence/PersistenceServices.php#L25">factory method</a> of the <code>\PDO</code> connection:</p>
<pre><code class="language-php">public function pdoConnection(): \PDO
{
    return $this-&gt;makeSingleton(\PDO::class, function () {
        $this-&gt;assertMandatoryConfigExists('pdo.dsn');
        $this-&gt;assertMandatoryConfigExists('pdo.user');
        $this-&gt;assertMandatoryConfigExists('pdo.pwd');
        return new \PDO(
            $this-&gt;config()-&gt;stringValue('pdo.dsn'),
            $this-&gt;config()-&gt;stringValue('pdo.user'),
            $this-&gt;config()-&gt;stringValue('pdo.pwd')
        );
    });
}
</code></pre>
<p><code>$this-&gt;assertMandatoryConfigExists(/*...*/)</code> is a helper function of the <code>ServiceFactory</code> marked as private. It is ignored by Discolight but we can use
it within factory methods.</p>
<pre><code class="language-php">private function assertMandatoryConfigExists(string $path): void
{
    if(null === $this-&gt;config-&gt;mixedValue($path)) {
        throw  new \RuntimeException("Missing application config for $path");
    }
}
</code></pre>
<h2 id="3-7-7">Service Alias</h2>
<p>In some cases using a full qualified class name (FQCN) of an interface or class as service id is not suitable. In such a case you can configure an <strong>alias</strong>
like shown in the example:</p>
<pre><code class="language-php">$serviceFactory = new \MyService\ServiceFactory($config);

$container = new \EventEngine\Discolight\Discolight(
    $serviceFactory,
    [PostgresEventStore::class =&gt; 'prooph.event_store']
);
</code></pre>
<p>You pass a map of <strong>service id =&gt; alias name</strong> as second argument to Discolight.</p>
<h2 id="3-7-8">Production Optimization</h2>
<p>Discolight uses <code>\Reflection</code> to scan the ServiceFactory class and find out about public factory methods and their return types.
It's a myth that reflection is slow. However, rescanning the ServiceFactory on every request in a production environment just does not make sense.
Code does not change, so doing it once and remember the result is the better option.</p>
<pre><code class="language-php">
$serviceMapCache = null;

if(getenv('APP_ENV') === 'prod' &amp;&amp; file_exists('data/ee.cache.php')) {
    //Read cache from file
    $serviceMapCache = require 'data/ee.cache.php';
}

$serviceFactory = new \MyService\ServiceFactory($config);

$discolight = new \EventEngine\Discolight\Discolight(
    $serviceFactory,
    [PostgresEventStore::class =&gt; 'prooph.event_store'],
    $serviceMapCache // &lt;-- Pass cache as third argument. If it's NULL a rescan is triggered
);

if(!$serviceMapCache &amp;&amp; getenv('APP_ENV') === 'prod') {
    // ServiceFactoryMap is an array
    // var_export turns that array in a string parsable by PHP
    // The cache file itself is a PHP script that returns the array
    file_put_contents(
        'data/ee.cache.php',
        "&lt;?php\nreturn " . var_export($discolight-&gt;getServiceFactoryMap(), true) . ';'
    );    
}

</code></pre>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="https://event-engine.io/api/projections/set_up.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="https://event-engine.io/news/">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p><a href="http://prooph-software.de/about.html">Imprint</a> | Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<span id="forkongithub"><a href="https://github.com/event-engine/docs">Fork me on GitHub</a></span><script src="//code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="//bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="//tobiju.github.io/share/prismjs/main.js"></script>
<script src="//tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
<script src="https://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
</body></html>
